<!DOCTYPE html><html lang="en-us" class="__variable_dd5b2f scroll-smooth"><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="preload" href="/_next/static/media/36966cca54120369-s.p.woff2" as="font" crossorigin="" type="font/woff2"/><link rel="stylesheet" href="/_next/static/css/c890694439b2475b.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/1ea5cf861ee12a80.css" data-precedence="next"/><link rel="stylesheet" href="/_next/static/css/a9b9096fa657c0d0.css" data-precedence="next"/><link rel="preload" as="script" fetchPriority="low" href="/_next/static/chunks/webpack-8506c16620cf39fb.js"/><script src="/_next/static/chunks/fd9d1056-30760135124e6678.js" async=""></script><script src="/_next/static/chunks/23-44b8024386371b46.js" async=""></script><script src="/_next/static/chunks/main-app-06a10a1bb45617e8.js" async=""></script><script src="/_next/static/chunks/ebde5ed1-51545511fe0d5050.js" async=""></script><script src="/_next/static/chunks/231-34a6a67d2da26855.js" async=""></script><script src="/_next/static/chunks/827-69594f61c16b8a9c.js" async=""></script><script src="/_next/static/chunks/850-ecf153581cc02044.js" async=""></script><script src="/_next/static/chunks/app/layout-54bebb918ae7f176.js" async=""></script><script src="/_next/static/chunks/app/blog/%5B...slug%5D/page-bd056182432da53b.js" async=""></script><script src="https://us.umami.is/script.js" async=""></script><title>深入理解Go SQL内部机制</title><meta name="description" content="这是一篇关于Go SQL内部机制的深度解析文章。文章详细探讨了预处理语句的工作原理、连接池的生命周期管理，以及实际生产环境中常见的问题和解决方案。同时提供了具体的客户端和服务器端配置建议，对于构建高性能Go数据库应用具有重要的参考价值。"/><meta name="robots" content="index, follow"/><meta name="googlebot" content="index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1"/><link rel="canonical" href="https://blog.mainjay.cloudns.ch/blog/go/go-sql"/><link rel="alternate" type="application/rss+xml" href="https://blog.mainjay.cloudns.ch/feed.xml"/><meta property="og:title" content="深入理解Go SQL内部机制"/><meta property="og:description" content="这是一篇关于Go SQL内部机制的深度解析文章。文章详细探讨了预处理语句的工作原理、连接池的生命周期管理，以及实际生产环境中常见的问题和解决方案。同时提供了具体的客户端和服务器端配置建议，对于构建高性能Go数据库应用具有重要的参考价值。"/><meta property="og:url" content="https://blog.mainjay.cloudns.ch/blog/go/go-sql"/><meta property="og:site_name" content="MainJayLai Blog"/><meta property="og:locale" content="en_US"/><meta property="og:image" content="https://pngimg.com/uploads/github/github_PNG80.png"/><meta property="og:type" content="article"/><meta property="article:published_time" content="2024-11-13T00:00:00.000Z"/><meta property="article:modified_time" content="2024-11-13T00:00:00.000Z"/><meta property="article:author" content="mainJayLai"/><meta name="twitter:card" content="summary_large_image"/><meta name="twitter:title" content="深入理解Go SQL内部机制"/><meta name="twitter:description" content="这是一篇关于Go SQL内部机制的深度解析文章。文章详细探讨了预处理语句的工作原理、连接池的生命周期管理，以及实际生产环境中常见的问题和解决方案。同时提供了具体的客户端和服务器端配置建议，对于构建高性能Go数据库应用具有重要的参考价值。"/><meta name="twitter:image" content="https://pngimg.com/uploads/github/github_PNG80.png"/><meta name="next-size-adjust"/><link rel="icon" type="image/png" href="https://mainjaylai.github.io/favicon.png"/><link rel="manifest" href="/static/favicons/manifest.json"/><meta name="msapplication-TileColor" content="#000000"/><meta name="theme-color" media="(prefers-color-scheme: light)" content="#fff"/><meta name="theme-color" media="(prefers-color-scheme: dark)" content="#000"/><meta name="referrer" content="no-referrer"/><link rel="alternate" type="application/rss+xml" href="/feed.xml"/><link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@200..900&amp;display=swap" rel="stylesheet"/><link href="https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe&amp;family=ZCOOL+QingKe+HuangYou&amp;family=ZCOOL+XiaoWei&amp;display=swap" rel="stylesheet"/><script src="https://cdn.jsdelivr.net/gh/ashishagarwal2023/freegptjs@1.0.2/src/freegpt.min.js"></script><script src="/_next/static/chunks/polyfills-78c92fac7aa8fdd8.js" noModule=""></script></head><body class="bg-white pl-[calc(100vw-100%)] text-black antialiased dark:bg-gray-950 dark:text-white"><script>!function(){try{var d=document.documentElement,c=d.classList;c.remove('light','dark');var e=localStorage.getItem('theme');if('system'===e||(!e&&false)){var t='(prefers-color-scheme: dark)',m=window.matchMedia(t);if(m.media!==t||m.matches){d.style.colorScheme = 'dark';c.add('dark')}else{d.style.colorScheme = 'light';c.add('light')}}else if(e){c.add(e|| '')}else{c.add('light')}if(e==='light'||e==='dark'||!e)d.style.colorScheme=e||'light'}catch(e){}}()</script><section class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="flex h-screen flex-col justify-between font-sans"><header class="flex items-center justify-between py-5"><div><a aria-label="Blog" href="/"><div class="flex items-center justify-between"><div class="mr-3"><img alt="logo" loading="lazy" width="44" height="44" decoding="async" data-nimg="1" style="color:transparent" src="https://mainjaylai.github.io/favicon.png"/></div><div class="hidden h-[44px] text-center text-3xl font-semibold leading-10 sm:block">Blog</div></div></a></div><div class="flex items-center space-x-4 leading-5 sm:space-x-6"><a class="navbar-item hidden font-medium text-gray-900 dark:text-gray-100 sm:block" href="/blog">Blog</a><a class="navbar-item hidden font-medium text-gray-900 dark:text-gray-100 sm:block" href="/tags">Tags</a><a target="_blank" rel="noopener noreferrer" href="https://mainjaylai.github.io" class="navbar-item hidden font-medium text-gray-900 dark:text-gray-100 sm:block">About</a><button aria-label="Search"><svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-6 w-6 text-gray-900 dark:text-gray-100"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"></path></svg></button><div class="mr-8"><div class="relative inline-block text-left" data-headlessui-state=""><div><button id="headlessui-menu-button-:R5pkqja:" type="button" aria-haspopup="menu" aria-expanded="false" data-headlessui-state=""><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-6 w-6 text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" clip-rule="evenodd"></path></svg></button></div></div></div><button aria-label="AI Chat" class="flex items-center justify-center rounded-full p-1.5 text-gray-800 transition-all hover:bg-gray-100 dark:text-gray-200 dark:hover:bg-gray-800"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path><path d="M8 9h8"></path><path d="M8 13h6"></path></svg></button><div class="mr-5"><div class="relative inline-block text-left" data-headlessui-state=""><div><button class="flex items-center" id="headlessui-menu-button-:R6pkqja:" type="button" aria-haspopup="menu" aria-expanded="false" data-headlessui-state=""><div class="mr-2">简体中文</div><svg viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1616" width="15" height="15"><path d="M670.72 325.696L511.552 152l87.68-87.872 360.96 389.504L832 453.76v0.64H64V325.76h606.72z m-318.4 382.08l157.248 172.8-94.976 79.552L63.872 579.84l147.712-0.704v-0.128H960v128.768H352.32z" fill="#262626" p-id="1617"></path></svg></button></div></div></div><button aria-label="Toggle Menu" class="sm:hidden"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-8 w-8 text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg></button><div class="opacity-98 fixed left-0 top-0 z-10 h-full w-full transform bg-white duration-300 ease-in-out dark:bg-gray-950 dark:opacity-[0.98] translate-x-full"><div class="flex justify-end"><button class="mr-8 mt-8 h-8 w-8" aria-label="Toggle Menu"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="text-gray-900 dark:text-gray-100"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg></button></div><nav class="fixed mt-8 h-full"><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 opacity-80 dark:text-gray-100" href="/">Home</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 opacity-80 dark:text-gray-100" href="/blog">Blog</a></div><div class="px-12 py-4"><a class="text-2xl font-bold tracking-widest text-gray-900 opacity-80 dark:text-gray-100" href="/tags">Tags</a></div><div class="px-12 py-4"><a target="_blank" rel="noopener noreferrer" href="https://mainjaylai.github.io" class="text-2xl font-bold tracking-widest text-gray-900 opacity-80 dark:text-gray-100">About</a></div></nav></div></div></header><main class="mb-auto"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","headline":"深入理解Go SQL内部机制","datePublished":"2024-11-13T00:00:00.000Z","dateModified":"2024-11-13T00:00:00.000Z","description":"这是一篇关于Go SQL内部机制的深度解析文章。文章详细探讨了预处理语句的工作原理、连接池的生命周期管理，以及实际生产环境中常见的问题和解决方案。同时提供了具体的客户端和服务器端配置建议，对于构建高性能Go数据库应用具有重要的参考价值。","image":"https://pngimg.com/uploads/github/github_PNG80.png","url":"https://blog.mainjay.cloudns.ch/blog/go/go-sql","author":[{"@type":"Person","name":"mainJayLai"}]}</script><section class="mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0"><div class="fixed bottom-8 right-8 hidden flex-col gap-3 md:hidden"><button aria-label="Scroll To Comment" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10c0 3.866-3.582 7-8 7a8.841 8.841 0 01-4.083-.98L2 17l1.338-3.123C2.493 12.767 2 11.434 2 10c0-3.866 3.582-7 8-7s8 3.134 8 7zM7 9H5v2h2V9zm8 0h-2v2h2V9zM9 9h2v2H9V9z" clip-rule="evenodd"></path></svg></button><button aria-label="Scroll To Top" class="rounded-full bg-gray-200 p-2 text-gray-500 transition-all hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-400 dark:hover:bg-gray-600"><svg class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.293 9.707a1 1 0 010-1.414l6-6a1 1 0 011.414 0l6 6a1 1 0 01-1.414 1.414L11 5.414V17a1 1 0 11-2 0V5.414L4.707 9.707a1 1 0 01-1.414 0z" clip-rule="evenodd"></path></svg></button></div><article><div><header><div class="space-y-1 border-b border-gray-200 pb-10 text-center dark:border-gray-700"><div class="beautiful-chinese-title"><h1 class="text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14">深入理解Go SQL内部机制</h1></div><dl><div><dt class="sr-only">Published on</dt><dd class="text-base font-medium leading-6 text-gray-500 dark:text-gray-400"><time dateTime="2024-11-13T00:00:00.000Z">November 13, 2024</time></dd></div></dl></div></header><div class="grid-rows-[auto_1fr] divide-y divide-gray-200 pb-8 dark:divide-gray-700 xl:divide-y-0"><div class="divide-y divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0"><div class="beautiful-chinese-content prose max-w-none pb-8 pt-10 dark:prose-invert"><h2 class="content-header" id="引言"><a href="#引言" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>引言</h2><p>在本文中，我们将探索Go的SQL和MySQL驱动程序的内部工作原理，揭示优化数据库交互和最小化错误的关键见解。这些见解来自对Go SQL标准库和Go MySQL驱动程序源代码的深入研究。</p><p>主要关键点：</p><ul><li>预处理语句：高效且安全的SQL执行</li><li>连接生命周期：资源使用和连接池维护</li><li>实际问题：解决微服务架构中的常见挑战</li></ul><p>在下文中，我们通过内联方式阐释Go概念。小写术语表示包名，大写术语表示类型名。括号表示方法，没有括号则表示类型。例如，<code class="custom-code">sql.Stmt</code>指的是sql包中的Stmt类型，而<code class="custom-code">Stmt.QueryContext()</code>表示Stmt类型上的QueryContext方法。</p><h3 class="content-header" id="为什么这很重要"><a href="#为什么这很重要" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>为什么这很重要</h3><p><strong>深入理解SQL和MySQL驱动程序在Go中的工作方式对构建高性能应用至关重要</strong>。通过深入研究预处理语句和连接生命周期等概念，我们可以优化数据库交互并有效处理故障。这些知识使开发人员能够编写更好的代码，并最大限度地减少数据库问题导致的错误。</p><h2 class="content-header" id="预处理语句"><a href="#预处理语句" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>预处理语句</h2><p>预处理语句是由DBMS解析和保存的SQL，通常包含占位符但没有实际参数值。之后，该语句可以使用一组参数值执行。</p><p>预处理语句的优势是：</p><ul><li><strong>效率</strong>：可以重复使用而无需重新编译</li><li><strong>安全性</strong>：减少或消除SQL注入攻击</li></ul><p>虽然出于安全目的使用预处理语句确实是个好理由，但说实话，它们使用的主要动机是效率，正如我将在本文其余部分进一步解释的那样。</p><h3 class="content-header" id="预处理语句生命周期"><a href="#预处理语句生命周期" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>预处理语句生命周期</h3><p>当我们想要在预处理语句上执行查询时，需要执行以下步骤：</p><ol><li><strong>语句准备</strong>：<code class="custom-code">DB.Prepare()</code>方法准备SQL语句并返回一个<code class="custom-code">sql.Stmt</code>对象</li><li><strong>查询执行</strong>：当使用<code class="custom-code">Stmt.Query()</code>执行查询时，驱动程序从连接池中检索连接，将SQL语句发送到数据库服务器，并等待结果</li></ol><h3 class="content-header" id="语句准备"><a href="#语句准备" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>语句准备</h3><p>要准备语句，客户端从连接池中获取连接并将查询发送到DBMS，DBMS解析查询并将语句ID返回给客户端，然后客户端构建<code class="custom-code">sql.Stmt</code>对象。</p><h3 class="content-header" id="查询执行"><a href="#查询执行" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>查询执行</h3><p>要使用<code class="custom-code">Stmt.QueryContext()</code>执行查询，客户端从池中检索连接。预处理语句的范围仅限于创建它的连接。因此，<code class="custom-code">sql.Stmt</code>必须验证连接是否已准备好。如果没有，它会自动准备连接，发送参数，并返回<code class="custom-code">sql.Rows</code>。随后，我们使用<code class="custom-code">Rows.Scan()</code>检索行数据。调用<code class="custom-code">Rows.Close()</code>时释放连接。</p><p>我们在这里获得效率，因为每次需要运行查询时都不需要发送整个查询字符串，DBMS也不需要解析查询。如果QPS（每秒查询数）很高，先准备它，然后执行它是有意义的。</p><p>到目前为止，我已经概述了使用连接的两个阶段：获取和释放它们。</p><p>让我们先讨论释放连接，然后再讨论如何获取连接。</p><h3 class="content-header" id="释放连接"><a href="#释放连接" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>释放连接</h3><p>一旦查询执行完成并处理结果集，连接就返回到连接池中，允许其他查询重用它。</p><p>释放SQL连接的关键规则：</p><div class="flex flex-col items-center justify-center text-center"><div><img alt="Maple" loading="lazy" width="828" height="417" decoding="async" data-nimg="1" style="color:transparent" src="/static/images/go/go-sql/picture1.webp"/> 在Go中释放SQL连接：检查最大打开和空闲连接，并处理挂起的请求。</div></div><div class="relative"><pre><code class="code-highlight language-go"><span class="code-line"><span class="token comment">// 设置最大打开连接数</span>
</span><span class="code-line">db<span class="token punctuation">.</span><span class="token function">SetMaxOpenConns</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">// 设置最大空闲连接数</span>
</span><span class="code-line">db<span class="token punctuation">.</span><span class="token function">SetMaxIdleConns</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
</span></code></pre></div><ul><li>如果当前打开的连接数超过了<code class="custom-code">DB.SetMaxOpenConns(int)</code>允许的最大值，空闲连接会立即关闭而不返回到空闲列表</li><li>如果有挂起的连接请求，空闲连接会转发给该请求；否则，如果挂起的连接数低于<code class="custom-code">DB.SetMaxIdleConns(int)</code>设置的最大空闲连接数，连接会被追加到空闲连接列表中以供后续使用</li><li>否则，连接将立即关闭，<code class="custom-code">DBStats.MaxIdleClosed</code>指标增加。</li></ul><p>Go不会无限期保留空闲连接；它会定期清理它们。连接清理作业会关闭空闲时间超过最大空闲时间的连接，以及生命周期超过最大生命周期的连接。这个过程确保空闲连接得到及时清理。两个指标<code class="custom-code">DBStats.MaxIdleTimeClosed</code>和<code class="custom-code">DBStats.MaxLifetimeClosed</code>表示这种行为。</p><p>在内部，三个测量指标代表这些连接：</p><ul><li><code class="custom-code">DBStats.Idle</code>：显示可用的空闲连接数</li><li><code class="custom-code">DBStats.InUse</code>：表示当前运行查询的连接数</li><li><code class="custom-code">DBStats.OpenConnections</code>：这两个指标的总和</li></ul><h3 class="content-header" id="获取连接"><a href="#获取连接" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>获取连接</h3><p>现在，让我们深入研究管理数据库连接的过程。</p><div class="flex flex-col items-center justify-center text-center"><div><img alt="Maple" loading="lazy" width="1386" height="882" decoding="async" data-nimg="1" style="color:transparent" src="/static/images/go/go-sql/picture2.webp"/> 在Go中获取/抓取SQL连接：重用现有连接、打开新连接和管理连接到期</div></div><h4 class="content-header" id="连接重用尝试"><a href="#连接重用尝试" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>连接重用尝试</h4><p>当使用Go时，它会尝试重用空闲列表中的连接。它检查每个连接的生命周期。如果连接的生命周期超过由<code class="custom-code">DB.SetConnMaxLifetime(time.Duration)</code>设置的最大值，它会关闭连接并返回<code class="custom-code">driver.ErrBadConn</code>。在两次重试后，如果错误仍然存在，它会尝试打开新连接。在返回连接之前，它会使用其DB驱动程序（例如MySQL驱动程序）重置连接，以验证连接的活跃性。</p><h4 class="content-header" id="处理连接稀缺"><a href="#处理连接稀缺" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>处理连接稀缺</h4><p>如果我们用完了空闲连接或被明确指示不使用连接，我们有两个选择：</p><ol><li>建立新连接</li><li>请求连接并等待直到连接池中有可用连接</li></ol><p>在这种情况下，它会重置连接。在等待连接可用时，两个额外的指标会增加：<code class="custom-code">DBStats.WaitCount</code>和<code class="custom-code">DBStats.WaitDuration</code>。</p><h2 class="content-header" id="实际问题"><a href="#实际问题" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>实际问题</h2><p>我们有一些使用Go编程语言开发的微服务。这些微服务使用MariaDB服务集群进行数据持久化。我们使用ProxySQL来为这些服务提供高可用性。</p><div class="flex flex-col items-center justify-center text-center"><div><img alt="Maple" loading="lazy" width="828" height="800" decoding="async" data-nimg="1" style="color:transparent" src="/static/images/go/go-sql/picture3.webp"/> ProxySQL和MariaDB集群的服务架构</div></div><p><strong>如果我们无法从DBMS获取数据，我们会向客户端响应内部错误</strong>。故障可能出现在以下链接之一：</p><ul><li>应用服务器和ProxySQL集群之间</li><li>ProxySQL服务和MariaDB服务之间</li></ul><p>如果这些链接中的任何一个失败，都可能导致运行查询时出错，从而增加内部错误率。</p><h3 class="content-header" id="waitcount增加问题"><a href="#waitcount增加问题" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>WaitCount增加问题</h3><p>一个奇怪的现象是，根据我们的指标，打开的连接数只有最大限制的一半。</p><div class="flex flex-col items-center justify-center text-center"><div><img alt="Maple" loading="lazy" width="828" height="237" decoding="async" data-nimg="1" style="color:transparent" src="/static/images/go/go-sql/picture4.webp"/> 打开的连接数稳定在15左右</div></div><p>因此，等待计数不应该增加，但它确实增加了。如果等待持续时间不保持稳定，它可能会影响响应时间。</p><div class="flex flex-col items-center justify-center text-center"><div><img alt="Maple" loading="lazy" width="828" height="237" decoding="async" data-nimg="1" style="color:transparent" src="/static/images/go/go-sql/picture5.webp"/> waitCount 在增加</div></div><p><strong>突然增加的请求会导致连接使用增加，由于采样间隔（每10-15秒），这种情况往往不会立即显现</strong>。例如，虽然一个图表显示稳定的打开连接，但另一个可能显示等待计数激增，表明请求增加。仅60个额外的同时请求就会导致空闲连接饱和，造成队列。仅依赖单一指标可能导致误解；考虑多个指标对准确性至关重要。</p><p>要解决此问题，请考虑增加最大打开连接数（<code class="custom-code">DB.SetMaxOpenConns(int)</code>）。如果由于应用程序实例总数超过总允许的最大连接数而无法提高此限制，你可能需要在增加最大打开连接数之前减少应用程序实例的数量。</p><h3 class="content-header" id="内部错误增加"><a href="#内部错误增加" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>内部错误增加</h3><p>我的探索发现，虽然Go的SQL标准库尝试重置连接以进行可用性检查，但它并不能完全修复无效连接错误。例如意外EOF等错误会影响响应时间，增加内部错误，并使用户不满意。调查显示，这个问题是由DBMS相关服务器参数（如ProxySQL或MariaDB）调整不当造成的。</p><div class="relative"><pre><code class="code-highlight language-js"><span class="code-line"><span class="token class-name known-class-name">Error</span> #<span class="token number">01</span><span class="token operator">:</span> invalid connection
</span><span class="code-line"><span class="token punctuation">[</span>mysql<span class="token punctuation">]</span> <span class="token number">2024</span><span class="token operator">/</span><span class="token number">03</span><span class="token operator">/</span><span class="token number">29</span> <span class="token number">16</span><span class="token operator">:</span><span class="token number">49</span><span class="token operator">:</span><span class="token number">43</span> packets<span class="token punctuation">.</span><span class="token property-access">go</span><span class="token operator">:</span><span class="token number">37</span><span class="token operator">:</span> unexpected <span class="token constant">EOF</span>
</span></code></pre></div><p>MySQL在<code class="custom-code">wait_timeout</code>后终止空闲连接，但ProxySQL没有收到通知，导致错误假设连接状态。</p><p>要解决这个问题，需要将<code class="custom-code">mysql-ping_interval_server_msec</code>减少到与<code class="custom-code">wait_timeout</code>相匹配或更低。这会提示ProxySQL检查空闲连接并避免将请求重定向到已终止的连接。</p><p>使用这些设置还将完全解决ProxySQL的以下警告。</p><div class="relative"><pre><code class="code-highlight language-js"><span class="code-line">mariadb3 <span class="token operator">|</span> <span class="token number">2024</span>–<span class="token number">03</span>–<span class="token number">28</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">07</span><span class="token operator">:</span><span class="token number">34</span> <span class="token number">591</span> <span class="token punctuation">[</span><span class="token maybe-class-name">Warning</span><span class="token punctuation">]</span> <span class="token maybe-class-name">Aborted</span> connection <span class="token number">591</span> to db<span class="token operator">:</span> <span class="token string">&#x27;mydb&#x27;</span> <span class="token literal-property property">user</span><span class="token operator">:</span> <span class="token string">&#x27;app&#x27;</span> <span class="token literal-property property">host</span><span class="token operator">:</span> <span class="token string">&#x27;172.25.0.5&#x27;</span> <span class="token punctuation">(</span><span class="token maybe-class-name">Got</span> timeout reading communication packets<span class="token punctuation">)</span>
</span><span class="code-line"><span class="token maybe-class-name">Then</span> it gets the following error when the app tries to open <span class="token keyword">new</span> <span class="token class-name">connection</span><span class="token operator">:</span>
</span><span class="code-line">proxysql <span class="token operator">|</span> <span class="token number">2024</span>–<span class="token number">03</span>–<span class="token number">28</span> <span class="token number">21</span><span class="token operator">:</span><span class="token number">08</span><span class="token operator">:</span><span class="token number">56</span> <span class="token maybe-class-name">MySQL_Session</span><span class="token punctuation">.</span><span class="token property-access">cpp</span><span class="token operator">:</span><span class="token number">1694</span><span class="token operator">:</span><span class="token function">handler_again___status_PINGING_SERVER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">ERROR</span><span class="token punctuation">]</span> <span class="token maybe-class-name">Detected</span> a broken connection <span class="token keyword control-flow">while</span> during ping <span class="token function">on</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span>mariadb2<span class="token punctuation">,</span><span class="token number">3306</span><span class="token punctuation">,</span><span class="token number">604</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> <span class="token constant">FD</span> <span class="token punctuation">(</span><span class="token maybe-class-name">Conn</span><span class="token operator">:</span><span class="token number">80</span> <span class="token punctuation">,</span> <span class="token literal-property property">MyDS</span><span class="token operator">:</span><span class="token number">80</span><span class="token punctuation">)</span> <span class="token punctuation">,</span> user app <span class="token punctuation">,</span> last_used 0ms ago <span class="token operator">:</span> <span class="token number">2006</span><span class="token punctuation">,</span> <span class="token maybe-class-name">MySQL</span> server has gone away
</span></code></pre></div><p>ProxySQL不会关闭连接，从而导致记录上述错误。</p><blockquote><p>默认情况下，连接不会根据其年龄而关闭。当达到<code class="custom-code">mysql-connection_max_age_ms</code>时，连接会简单地断开，而不会向服务器发送<code class="custom-code">COM_QUIT</code>命令，因此这可能会导致mysql服务器日志中显示<strong>中止连接</strong>警告（这种行为是故意的）。</p></blockquote><h3 class="content-header" id="最大连接数"><a href="#最大连接数" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>最大连接数</h3><p>考虑这种情况：如果ProxySQL中的<code class="custom-code">max_connections</code>值设置为99，而我们在应用程序中将最大打开连接配置为100，测试显示99.5%的正常运行时间，有0.5%的响应导致内部错误。</p><p>ProxySQL会记录以下警告：</p><div class="relative"><pre><code class="code-highlight language-js"><span class="code-line">proxysql  <span class="token operator">|</span> <span class="token number">2024</span><span class="token operator">-</span><span class="token number">03</span><span class="token operator">-</span><span class="token number">30</span> <span class="token number">19</span><span class="token operator">:</span><span class="token number">38</span><span class="token operator">:</span><span class="token number">05</span> <span class="token maybe-class-name">MySQL_Session</span><span class="token punctuation">.</span><span class="token property-access">cpp</span><span class="token operator">:</span><span class="token number">5504</span><span class="token operator">:</span><span class="token function">handler___status_CONNECTING_CLIENT___STATE_SERVER_HANDSHAKE</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token constant">WARNING</span><span class="token punctuation">]</span> <span class="token maybe-class-name">User</span> <span class="token string">&#x27;app&#x27;</span> has exceeded the <span class="token string">&#x27;max_user_connections&#x27;</span> <span class="token function">resource</span> <span class="token punctuation">(</span>current value<span class="token operator">:</span> <span class="token number">99</span><span class="token punctuation">)</span>
</span></code></pre></div><p>这种情况强调了准确调整参数的重要性。</p><h2 class="content-header" id="建议"><a href="#建议" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>建议</h2><h3 class="content-header" id="客户端建议"><a href="#客户端建议" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>客户端建议</h3><p>Go-SQL-Driver的自述文件中提到了一些很好的建议：</p><blockquote><p><code class="custom-code">db.SetConnMaxLifetime()</code> 是必需的，用于确保驱动程序在连接被 MySQL 服务器、操作系统或其他中间件关闭之前安全地关闭连接。由于一些中间件会在 5 分钟后关闭空闲连接，我们建议将超时时间设置为小于 5 分钟。这个设置也有助于负载均衡和更改系统变量。</p><p><code class="custom-code">db.SetMaxOpenConns()</code> 强烈建议设置，用于限制应用程序使用的连接数量。没有推荐的具体限制数字，因为这取决于应用程序和 MySQL 服务器的具体情况。</p><p><code class="custom-code">db.SetMaxIdleConns()</code> 建议设置为与 <code class="custom-code">db.SetMaxOpenConns()</code> 相同的值。当它小于 <code class="custom-code">SetMaxOpenConns()</code> 时，连接的开启和关闭频率可能会比您预期的要高得多。空闲连接可以通过 <code class="custom-code">db.SetConnMaxLifetime()</code> 来关闭。如果您想更快地关闭空闲连接，从 Go 1.15 版本开始，您可以使用 <code class="custom-code">db.SetConnMaxIdleTime()</code>。</p></blockquote><p><strong>配置建议：</strong></p><div class="relative"><pre><code class="code-highlight language-go"><span class="code-line"><span class="token comment">// 设置连接最大生存期（小于wait_time设置）</span>
</span><span class="code-line">db<span class="token punctuation">.</span><span class="token function">SetConnMaxLifetime</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">// 设置与ConnMaxLifetime相同</span>
</span><span class="code-line">db<span class="token punctuation">.</span><span class="token function">SetConnMaxIdleTime</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">// 最大连接数限制除以pod数量</span>
</span><span class="code-line">db<span class="token punctuation">.</span><span class="token function">SetMaxOpenConns</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
</span><span class="code-line"><span class="token comment">// 与MaxOpenConns相同</span>
</span><span class="code-line">db<span class="token punctuation">.</span><span class="token function">SetMaxIdleConns</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span>
</span></code></pre></div><p>通过执行指定的查询，您将发现<code class="custom-code">max_connections</code>设置：</p><div class="relative"><pre><code class="code-highlight language-mysql"><span class="code-line">ProxySQL Admin&gt; select hostgroup_id, hostname, max_connections from mysql_servers;
</span><span class="code-line">+--------------+----------+-----------------+
</span><span class="code-line">| hostgroup_id | hostname | max_connections |
</span><span class="code-line">+--------------+----------+-----------------+
</span><span class="code-line">| 0            | mariadb1 | 20              |
</span><span class="code-line">| 1            | mariadb2 | 300             |
</span><span class="code-line">| 1            | mariadb3 | 300             |
</span><span class="code-line">+--------------+----------+-----------------+
</span><span class="code-line">
</span><span class="code-line">ProxySQL Admin&gt; select username, max_connections from mysql_users;
</span><span class="code-line">+----------+-----------------+
</span><span class="code-line">| username | max_connections |
</span><span class="code-line">+----------+-----------------+
</span><span class="code-line">| root     | 25              |
</span><span class="code-line">| app      | 300             |
</span><span class="code-line">+----------+-----------------+
</span><span class="code-line">
</span><span class="code-line">ProxySQL Admin&gt; select * from global_variables where variable_name in (&#x27;mysql-wait_timeout&#x27;) order by variable_name;
</span><span class="code-line">+--------------------+----------------+
</span><span class="code-line">| variable_name      | variable_value |
</span><span class="code-line">+--------------------+----------------+
</span><span class="code-line">| mysql-wait_timeout | 60000          |
</span><span class="code-line">+--------------------+----------------+
</span><span class="code-line">
</span><span class="code-line">mysql&gt; show variables where Variable_name in (&#x27;max_connections&#x27;,&#x27;wait_timeout&#x27;);
</span><span class="code-line">+-----------------+-------+
</span><span class="code-line">| Variable_name   | Value |
</span><span class="code-line">+-----------------+-------+
</span><span class="code-line">| max_connections | 300   |
</span><span class="code-line">| wait_timeout    | 600   |
</span><span class="code-line">+-----------------+-------+
</span></code></pre></div><p>根据这些值，我们应该将连接的最大生存期设置为最多60秒。如果我们运行一个应用程序的3个实例，则最大打开连接数应设置为100。</p><div class="relative"><pre><code class="code-highlight language-go"><span class="code-line">db<span class="token punctuation">.</span><span class="token function">SetConnMaxLifetime</span><span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</span><span class="code-line">db<span class="token punctuation">.</span><span class="token function">SetConnMaxIdleTime</span><span class="token punctuation">(</span><span class="token number">60</span> <span class="token operator">*</span> time<span class="token punctuation">.</span>Second<span class="token punctuation">)</span>
</span><span class="code-line">db<span class="token punctuation">.</span><span class="token function">SetMaxOpenConns</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
</span><span class="code-line">db<span class="token punctuation">.</span><span class="token function">SetMaxIdleConns</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
</span></code></pre></div><h3 class="content-header" id="服务器端建议"><a href="#服务器端建议" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>服务器端建议</h3><p>根据<code class="custom-code">wait_timeout</code>调整<code class="custom-code">mysql-ping_interval_server_msec</code>。它应该小于或等于<code class="custom-code">wait_timeout</code>，而不是更大。对已经被MySQL服务器终止的连接进行ping是没有意义的。</p><p><strong>示例配置查询：</strong></p><div class="relative"><pre><code class="code-highlight language-sql"><span class="code-line"><span class="token comment">-- 查询服务器配置</span>
</span><span class="code-line">ProxySQL Admin<span class="token operator">&gt;</span> <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> global_variables <span class="token keyword">where</span> variable_name <span class="token operator">in</span> <span class="token punctuation">(</span><span class="token string">&#x27;mysql-ping_interval_server_msec&#x27;</span><span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> variable_name<span class="token punctuation">;</span>
</span><span class="code-line"><span class="token operator">+</span><span class="token comment">---------------------------------+----------------+</span>
</span><span class="code-line"><span class="token operator">|</span> variable_name                   <span class="token operator">|</span> variable_value <span class="token operator">|</span>
</span><span class="code-line"><span class="token operator">+</span><span class="token comment">---------------------------------+----------------+</span>
</span><span class="code-line"><span class="token operator">|</span> mysql<span class="token operator">-</span>ping_interval_server_msec <span class="token operator">|</span> <span class="token number">120000</span>         <span class="token operator">|</span>
</span><span class="code-line"><span class="token operator">+</span><span class="token comment">---------------------------------+----------------+</span>
</span></code></pre></div><p>返回的结果表明配置设置不正确。适当的值应该小于60000毫秒（60秒）。值得一提的是，ProxySQL的默认值是10000毫秒（10秒）。</p><h2 class="content-header" id="动手实践"><a href="#动手实践" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>动手实践</h2><p>要开始，克隆源代码仓库。确保系统上安装了Go、K6和Docker。</p><div class="relative"><pre><code class="code-highlight language-bash"><span class="code-line"><span class="token function">git</span> clone git@github.com:empire/db-prepared-stmt.git
</span><span class="code-line"><span class="token class-name builtin">cd</span> galera
</span><span class="code-line"><span class="token function">docker</span> compose up --remove-orphans
</span></code></pre></div><p>集群启动后，执行以下命令运行服务：</p><div class="relative"><pre><code class="code-highlight language-bash"><span class="code-line">go run <span class="token class-name builtin">.</span>
</span></code></pre></div><p>要模拟样本负载，你可以使用k6命令或运行<code class="custom-code">run_watched.sh</code>脚本。为了方便监控MySQL资源和进程列表，我创建了一个名为<code class="custom-code">monitor.sh</code>的脚本。你可以使用命令<code class="custom-code">watch -n 1 ./monitor.sh</code>执行它。</p><p>如果需要自定义配置，打开<code class="custom-code">galera/docker-compose.yml</code>和<code class="custom-code">galera/proxysql/proxysql.cnf</code>文件。对变量进行必要的更改，然后重启Docker Compose命令。</p><h2 class="content-header" id="结论"><a href="#结论" aria-hidden="true" tabindex="-1"><span class="content-header-link"><svg class="h-5 linkicon w-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z"></path><path d="M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z"></path></svg></span></a>结论</h2><p><strong>理解Go的SQL和MySQL驱动程序的内部工作原理使开发人员能够优化数据库交互并有效解决潜在故障</strong>。通过利用预处理语句、管理连接生命周期和应用最佳实践，开发人员可以提高应用程序性能并最小化内部错误。</p><p>我的探索揭示了有效资源管理和故障排除技术的关键见解，特别是在分布式系统中。通过实施推荐的配置并及时了解数据库技术，开发人员可以确保应用程序的平稳运行并提供卓越的用户体验。</p></div></div><div class="pb-6 pt-6 text-center text-gray-700 dark:text-gray-300" id="comment"></div><footer><div class="flex flex-col text-sm font-medium sm:flex-row sm:justify-between sm:text-base"><div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" aria-label="Previous post: Go语言 HTTP 服务模糊测试教程" href="/blog/go/fuzzing-test">← <!-- -->Go语言 HTTP 服务模糊测试教程</a></div><div class="pt-4 xl:pt-8"><a class="text-primary-500 hover:text-primary-600 dark:hover:text-primary-400" aria-label="Next post: 深入探讨 JavaScript 中的函数式编程" href="/blog/frontend/javascript-function">深入探讨 JavaScript 中的函数式编程<!-- --> →</a></div></div></footer></div></div></article></section></main><footer><div class="mt-16 flex flex-col items-center"><div class="mb-3 flex space-x-4"><a class="text-sm !text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="mailto:mainjaylai@outlook.com"><span class="sr-only">mail</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" class="fill-current text-gray-700 hover:text-primary-500 dark:text-gray-200 dark:hover:text-primary-400 h-6 w-6"><path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z"></path><path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z"></path></svg></a><a class="text-sm !text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://github.com/mainjaylai"><span class="sr-only">github</span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="fill-current text-gray-700 hover:text-primary-500 dark:text-gray-200 dark:hover:text-primary-400 h-6 w-6"><path d="M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"></path></svg></a><a class="text-sm !text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://gitlab.com/JayMain"><span class="sr-only">gitlab</span><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 hover:text-primary-500 dark:text-gray-200 dark:hover:text-primary-400 h-6 w-6" width="200" height="200"><path d="M1022.08 579.712l-57.258667-176.426667-113.664-349.397333a19.413333 19.413333 0 0 0-36.992 0L700.501333 403.2H323.498667L209.877333 53.888C204.074667 35.84 178.56 35.84 172.8 53.76L59.136 403.157333 1.877333 579.712a39.424 39.424 0 0 0 14.122667 43.648L512 983.637333l496-360.234666a39.253333 39.253333 0 0 0 14.08-43.690667"></path></svg></a><a class="text-sm !text-gray-500 transition hover:text-gray-600" target="_blank" rel="noopener noreferrer" href="https://gitee.com/lmj2001"><span class="sr-only">gitee</span><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="fill-current text-gray-700 hover:text-primary-500 dark:text-gray-200 dark:hover:text-primary-400 h-6 w-6" width="200" height="200"><path d="M512 992C246.895625 992 32 777.104375 32 512S246.895625 32 512 32s480 214.895625 480 480-214.895625 480-480 480z m242.9521875-533.3278125h-272.56875a23.7121875 23.7121875 0 0 0-23.71125 23.7121875l-0.024375 59.255625c0 13.08 10.6078125 23.7121875 23.6878125 23.7121875h165.96c13.104375 0 23.7121875 10.6078125 23.7121875 23.6878125v11.855625a71.1121875 71.1121875 0 0 1-71.1121875 71.1121875h-225.215625a23.7121875 23.7121875 0 0 1-23.6878125-23.7121875V423.1278125a71.1121875 71.1121875 0 0 1 71.0878125-71.1121875h331.824375a23.7121875 23.7121875 0 0 0 23.6878125-23.71125l0.0721875-59.2565625a23.7121875 23.7121875 0 0 0-23.68875-23.7121875H423.08a177.76875 177.76875 0 0 0-177.76875 177.7921875V754.953125c0 13.1034375 10.60875 23.7121875 23.713125 23.7121875h349.63125a159.984375 159.984375 0 0 0 159.984375-159.984375V482.36a23.7121875 23.7121875 0 0 0-23.7121875-23.6878125z"></path></svg></a></div><div class="mb-2 flex space-x-2 text-sm text-gray-500 dark:text-gray-400"><div>MainJayLai</div><div> • </div><div>© 2025</div><div> • </div><a href="/">MainJayLai Blog</a></div></div></footer></div></section><script src="/_next/static/chunks/webpack-8506c16620cf39fb.js" async=""></script><script>(self.__next_f=self.__next_f||[]).push([0]);self.__next_f.push([2,null])</script><script>self.__next_f.push([1,"1:HL[\"/_next/static/media/36966cca54120369-s.p.woff2\",\"font\",{\"crossOrigin\":\"\",\"type\":\"font/woff2\"}]\n2:HL[\"/_next/static/css/c890694439b2475b.css\",\"style\"]\n3:HL[\"/_next/static/css/1ea5cf861ee12a80.css\",\"style\"]\n4:HL[\"/_next/static/css/a9b9096fa657c0d0.css\",\"style\"]\n"])</script><script>self.__next_f.push([1,"5:I[5751,[],\"\"]\n8:I[9275,[],\"\"]\na:I[1343,[],\"\"]\nb:I[8700,[\"599\",\"static/chunks/ebde5ed1-51545511fe0d5050.js\",\"231\",\"static/chunks/231-34a6a67d2da26855.js\",\"827\",\"static/chunks/827-69594f61c16b8a9c.js\",\"850\",\"static/chunks/850-ecf153581cc02044.js\",\"185\",\"static/chunks/app/layout-54bebb918ae7f176.js\"],\"ThemeProviders\"]\nc:I[4080,[\"599\",\"static/chunks/ebde5ed1-51545511fe0d5050.js\",\"231\",\"static/chunks/231-34a6a67d2da26855.js\",\"827\",\"static/chunks/827-69594f61c16b8a9c.js\",\"850\",\"static/chunks/850-ecf153581cc02044.js\",\"185\",\"static/chunks/app/layout-54bebb918ae7f176.js\"],\"\"]\nd:I[9032,[\"599\",\"static/chunks/ebde5ed1-51545511fe0d5050.js\",\"231\",\"static/chunks/231-34a6a67d2da26855.js\",\"827\",\"static/chunks/827-69594f61c16b8a9c.js\",\"850\",\"static/chunks/850-ecf153581cc02044.js\",\"185\",\"static/chunks/app/layout-54bebb918ae7f176.js\"],\"KBarSearchProvider\"]\ne:I[231,[\"231\",\"static/chunks/231-34a6a67d2da26855.js\",\"827\",\"static/chunks/827-69594f61c16b8a9c.js\",\"797\",\"static/chunks/app/blog/%5B...slug%5D/page-bd056182432da53b.js\"],\"\"]\nf:I[8173,[\"231\",\"static/chunks/231-34a6a67d2da26855.js\",\"827\",\"static/chunks/827-69594f61c16b8a9c.js\",\"797\",\"static/chunks/app/blog/%5B...slug%5D/page-bd056182432da53b.js\"],\"Image\"]\n10:I[509,[\"599\",\"static/chunks/ebde5ed1-51545511fe0d5050.js\",\"231\",\"static/chunks/231-34a6a67d2da26855.js\",\"827\",\"static/chunks/827-69594f61c16b8a9c.js\",\"850\",\"static/chunks/850-ecf153581cc02044.js\",\"185\",\"static/chunks/app/layout-54bebb918ae7f176.js\"],\"KBarButton\"]\n11:I[1398,[\"599\",\"static/chunks/ebde5ed1-51545511fe0d5050.js\",\"231\",\"static/chunks/231-34a6a67d2da26855.js\",\"827\",\"static/chunks/827-69594f61c16b8a9c.js\",\"850\",\"static/chunks/850-ecf153581cc02044.js\",\"185\",\"static/chunks/app/layout-54bebb918ae7f176.js\"],\"default\"]\n12:I[7606,[\"599\",\"static/chunks/ebde5ed1-51545511fe0d5050.js\",\"231\",\"static/chunks/231-34a6a67d2da26855.js\",\"827\",\"static/chunks/827-69594f61c16b8a9c.js\",\"850\",\"static/chunks/850-ecf153581cc02044.js\",\"185\",\"static/chunks/app/layout-54bebb918ae7f176.js\"],\"default\"]\n13:I[7510,[\"599\",\"static/chunks/ebde5ed1-5"])</script><script>self.__next_f.push([1,"1545511fe0d5050.js\",\"231\",\"static/chunks/231-34a6a67d2da26855.js\",\"827\",\"static/chunks/827-69594f61c16b8a9c.js\",\"850\",\"static/chunks/850-ecf153581cc02044.js\",\"185\",\"static/chunks/app/layout-54bebb918ae7f176.js\"],\"default\"]\n14:I[8976,[\"599\",\"static/chunks/ebde5ed1-51545511fe0d5050.js\",\"231\",\"static/chunks/231-34a6a67d2da26855.js\",\"827\",\"static/chunks/827-69594f61c16b8a9c.js\",\"850\",\"static/chunks/850-ecf153581cc02044.js\",\"185\",\"static/chunks/app/layout-54bebb918ae7f176.js\"],\"default\"]\n16:I[6130,[],\"\"]\n9:[\"slug\",\"go/go-sql\",\"c\"]\n17:[]\n"])</script><script>self.__next_f.push([1,"0:[[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/c890694439b2475b.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}],[\"$\",\"link\",\"1\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/1ea5cf861ee12a80.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]],[\"$\",\"$L5\",null,{\"buildId\":\"AO1lBacSEqBfLSl9iFzzQ\",\"assetPrefix\":\"\",\"initialCanonicalUrl\":\"/blog/go/go-sql\",\"initialTree\":[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"go/go-sql\",\"c\"],{\"children\":[\"__PAGE__?{\\\"slug\\\":[\\\"go\\\",\\\"go-sql\\\"]}\",{}]}]}]},\"$undefined\",\"$undefined\",true],\"initialSeedData\":[\"\",{\"children\":[\"blog\",{\"children\":[[\"slug\",\"go/go-sql\",\"c\"],{\"children\":[\"__PAGE__\",{},[[\"$L6\",\"$L7\"],null],null]},[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\",\"$9\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":[[\"$\",\"link\",\"0\",{\"rel\":\"stylesheet\",\"href\":\"/_next/static/css/a9b9096fa657c0d0.css\",\"precedence\":\"next\",\"crossOrigin\":\"$undefined\"}]]}],null]},[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\",\"blog\",\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":\"$undefined\",\"notFoundStyles\":\"$undefined\",\"styles\":null}],null]},[[\"$\",\"html\",null,{\"lang\":\"en-us\",\"className\":\"__variable_dd5b2f scroll-smooth\",\"suppressHydrationWarning\":true,\"children\":[[\"$\",\"head\",null,{\"children\":[[\"$\",\"link\",null,{\"rel\":\"icon\",\"type\":\"image/png\",\"href\":\"https://mainjaylai.github.io/favicon.png\"}],[\"$\",\"link\",null,{\"rel\":\"manifest\",\"href\":\"/static/favicons/manifest.json\"}],[\"$\",\"meta\",null,{\"name\":\"msapplication-TileColor\",\"content\":\"#000000\"}],[\"$\",\"link\",null,{\"href\":\"https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@200..900\u0026display=swap\",\"rel\":\"stylesheet\"}],[\"$\",\"link\",null,{\"href\":\"https://fonts.googleapis.com/css2?family=ZCOOL+KuaiLe\u0026family=ZCOOL+QingKe+HuangYou\u0026family=ZCOOL+XiaoWei\u0026display=swap\",\"rel\":\"stylesheet\"}],[\"$\",\"script\",null,{\"src\":\"https://us.umami.is/script.js\",\"async\":true}],[\"$\",\"meta\",null,{\"name\":\"theme-color\",\"media\":\"(prefers-color-scheme: light)\",\"content\":\"#fff\"}],[\"$\",\"meta\",null,{\"name\":\"theme-color\",\"media\":\"(prefers-color-scheme: dark)\",\"content\":\"#000\"}],[\"$\",\"meta\",null,{\"name\":\"referrer\",\"content\":\"no-referrer\"}],[\"$\",\"script\",null,{\"src\":\"https://cdn.jsdelivr.net/gh/ashishagarwal2023/freegptjs@1.0.2/src/freegpt.min.js\"}],[\"$\",\"link\",null,{\"rel\":\"alternate\",\"type\":\"application/rss+xml\",\"href\":\"/feed.xml\"}]]}],[\"$\",\"body\",null,{\"className\":\"bg-white pl-[calc(100vw-100%)] text-black antialiased dark:bg-gray-950 dark:text-white\",\"suppressHydrationWarning\":true,\"children\":[\"$\",\"$Lb\",null,{\"children\":[[\"$undefined\",\"$undefined\",\"$undefined\",[\"$\",\"$Lc\",null,{\"async\":true,\"defer\":true,\"data-website-id\":\"bbe21cb3-3de3-4ba7-b6de-453053bc6ae8\",\"src\":\"https://us.umami.is/script.js\"}],\"$undefined\",\"$undefined\"],[\"$\",\"section\",null,{\"className\":\"mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex h-screen flex-col justify-between font-sans\",\"children\":[[\"$\",\"$Ld\",null,{\"kbarConfig\":{\"searchDocumentsPath\":\"/search.json\"},\"children\":[[\"$\",\"header\",null,{\"className\":\"flex items-center justify-between py-5\",\"children\":[[\"$\",\"div\",null,{\"children\":[\"$\",\"$Le\",null,{\"href\":\"/\",\"aria-label\":\"Blog\",\"children\":[\"$\",\"div\",null,{\"className\":\"flex items-center justify-between\",\"children\":[[\"$\",\"div\",null,{\"className\":\"mr-3\",\"children\":[\"$\",\"$Lf\",null,{\"src\":\"https://mainjaylai.github.io/favicon.png\",\"width\":44,\"height\":44,\"alt\":\"logo\"}]}],[\"$\",\"div\",null,{\"className\":\"hidden h-[44px] text-center text-3xl font-semibold leading-10 sm:block\",\"children\":\"Blog\"}]]}]}]}],[\"$\",\"div\",null,{\"className\":\"flex items-center space-x-4 leading-5 sm:space-x-6\",\"children\":[[[\"$\",\"$Le\",null,{\"href\":\"/blog\",\"className\":\"navbar-item hidden font-medium text-gray-900 dark:text-gray-100 sm:block\",\"children\":\"Blog\"}],[\"$\",\"$Le\",null,{\"href\":\"/tags\",\"className\":\"navbar-item hidden font-medium text-gray-900 dark:text-gray-100 sm:block\",\"children\":\"Tags\"}],[\"$\",\"a\",null,{\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://mainjaylai.github.io\",\"className\":\"navbar-item hidden font-medium text-gray-900 dark:text-gray-100 sm:block\",\"children\":\"About\"}]],[\"$\",\"$L10\",null,{\"aria-label\":\"Search\",\"children\":[\"$\",\"svg\",null,{\"xmlns\":\"http://www.w3.org/2000/svg\",\"fill\":\"none\",\"viewBox\":\"0 0 24 24\",\"strokeWidth\":1.5,\"stroke\":\"currentColor\",\"className\":\"h-6 w-6 text-gray-900 dark:text-gray-100\",\"children\":[\"$\",\"path\",null,{\"strokeLinecap\":\"round\",\"strokeLinejoin\":\"round\",\"d\":\"M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z\"}]}]}],[\"$\",\"$L11\",null,{}],[\"$\",\"$L12\",null,{}],[\"$\",\"$L13\",null,{}],[\"$\",\"$L14\",null,{}]]}]]}],[\"$\",\"main\",null,{\"className\":\"mb-auto\",\"children\":[\"$\",\"$L8\",null,{\"parallelRouterKey\":\"children\",\"segmentPath\":[\"children\"],\"error\":\"$undefined\",\"errorStyles\":\"$undefined\",\"errorScripts\":\"$undefined\",\"template\":[\"$\",\"$La\",null,{}],\"templateStyles\":\"$undefined\",\"templateScripts\":\"$undefined\",\"notFound\":[\"$\",\"div\",null,{\"className\":\"flex flex-col items-start justify-start md:mt-24 md:flex-row md:items-center md:justify-center md:space-x-6\",\"children\":[[\"$\",\"div\",null,{\"className\":\"space-x-2 pb-8 pt-6 md:space-y-5\",\"children\":[\"$\",\"h1\",null,{\"className\":\"text-6xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 md:border-r-2 md:px-6 md:text-8xl md:leading-14\",\"children\":\"404\"}]}],[\"$\",\"div\",null,{\"className\":\"max-w-md\",\"children\":[[\"$\",\"p\",null,{\"className\":\"mb-4 text-xl font-bold leading-normal md:text-2xl\",\"children\":\"Sorry we couldn't find this page.\"}],[\"$\",\"p\",null,{\"className\":\"mb-8\",\"children\":\"But dont worry, you can find plenty of other things on our homepage.\"}],[\"$\",\"$Le\",null,{\"href\":\"/\",\"className\":\"focus:shadow-outline-blue inline rounded-lg border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium leading-5 text-white shadow transition-colors duration-150 hover:bg-blue-700 focus:outline-none dark:hover:bg-blue-500\",\"children\":\"Back to homepage\"}]]}]]}],\"notFoundStyles\":[],\"styles\":null}]}]]}],[\"$\",\"footer\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"mt-16 flex flex-col items-center\",\"children\":[[\"$\",\"div\",null,{\"className\":\"mb-3 flex space-x-4\",\"children\":[[\"$\",\"a\",null,{\"className\":\"text-sm !text-gray-500 transition hover:text-gray-600\",\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"mailto:mainjaylai@outlook.com\",\"children\":[[\"$\",\"span\",null,{\"className\":\"sr-only\",\"children\":\"mail\"}],[\"$\",\"svg\",null,{\"xmlns\":\"http://www.w3.org/2000/svg\",\"viewBox\":\"0 0 20 20\",\"className\":\"fill-current text-gray-700 hover:text-primary-500 dark:text-gray-200 dark:hover:text-primary-400 h-6 w-6\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z\"}],[\"$\",\"path\",null,{\"d\":\"M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z\"}]]}]]}],[\"$\",\"a\",null,{\"className\":\"text-sm !text-gray-500 transition hover:text-gray-600\",\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://github.com/mainjaylai\",\"children\":[[\"$\",\"span\",null,{\"className\":\"sr-only\",\"children\":\"github\"}],[\"$\",\"svg\",null,{\"xmlns\":\"http://www.w3.org/2000/svg\",\"viewBox\":\"0 0 24 24\",\"className\":\"fill-current text-gray-700 hover:text-primary-500 dark:text-gray-200 dark:hover:text-primary-400 h-6 w-6\",\"children\":[\"$\",\"path\",null,{\"d\":\"M12 .297c-6.63 0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577 0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93 0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176 0 0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22 0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22 0 1.606-.015 2.896-.015 3.286 0 .315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12\"}]}]]}],[\"$\",\"a\",null,{\"className\":\"text-sm !text-gray-500 transition hover:text-gray-600\",\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://gitlab.com/JayMain\",\"children\":[[\"$\",\"span\",null,{\"className\":\"sr-only\",\"children\":\"gitlab\"}],[\"$\",\"svg\",null,{\"viewBox\":\"0 0 1024 1024\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"className\":\"fill-current text-gray-700 hover:text-primary-500 dark:text-gray-200 dark:hover:text-primary-400 h-6 w-6\",\"width\":\"200\",\"height\":\"200\",\"children\":[\"$\",\"path\",null,{\"d\":\"M1022.08 579.712l-57.258667-176.426667-113.664-349.397333a19.413333 19.413333 0 0 0-36.992 0L700.501333 403.2H323.498667L209.877333 53.888C204.074667 35.84 178.56 35.84 172.8 53.76L59.136 403.157333 1.877333 579.712a39.424 39.424 0 0 0 14.122667 43.648L512 983.637333l496-360.234666a39.253333 39.253333 0 0 0 14.08-43.690667\"}]}]]}],[\"$\",\"a\",null,{\"className\":\"text-sm !text-gray-500 transition hover:text-gray-600\",\"target\":\"_blank\",\"rel\":\"noopener noreferrer\",\"href\":\"https://gitee.com/lmj2001\",\"children\":[[\"$\",\"span\",null,{\"className\":\"sr-only\",\"children\":\"gitee\"}],[\"$\",\"svg\",null,{\"viewBox\":\"0 0 1024 1024\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"className\":\"fill-current text-gray-700 hover:text-primary-500 dark:text-gray-200 dark:hover:text-primary-400 h-6 w-6\",\"width\":\"200\",\"height\":\"200\",\"children\":[\"$\",\"path\",null,{\"d\":\"M512 992C246.895625 992 32 777.104375 32 512S246.895625 32 512 32s480 214.895625 480 480-214.895625 480-480 480z m242.9521875-533.3278125h-272.56875a23.7121875 23.7121875 0 0 0-23.71125 23.7121875l-0.024375 59.255625c0 13.08 10.6078125 23.7121875 23.6878125 23.7121875h165.96c13.104375 0 23.7121875 10.6078125 23.7121875 23.6878125v11.855625a71.1121875 71.1121875 0 0 1-71.1121875 71.1121875h-225.215625a23.7121875 23.7121875 0 0 1-23.6878125-23.7121875V423.1278125a71.1121875 71.1121875 0 0 1 71.0878125-71.1121875h331.824375a23.7121875 23.7121875 0 0 0 23.6878125-23.71125l0.0721875-59.2565625a23.7121875 23.7121875 0 0 0-23.68875-23.7121875H423.08a177.76875 177.76875 0 0 0-177.76875 177.7921875V754.953125c0 13.1034375 10.60875 23.7121875 23.713125 23.7121875h349.63125a159.984375 159.984375 0 0 0 159.984375-159.984375V482.36a23.7121875 23.7121875 0 0 0-23.7121875-23.6878125z\"}]}]]}]]}],[\"$\",\"div\",null,{\"className\":\"mb-2 flex space-x-2 text-sm text-gray-500 dark:text-gray-400\",\"children\":[[\"$\",\"div\",null,{\"children\":\"MainJayLai\"}],[\"$\",\"div\",null,{\"children\":\" • \"}],[\"$\",\"div\",null,{\"children\":\"© 2025\"}],[\"$\",\"div\",null,{\"children\":\" • \"}],[\"$\",\"$Le\",null,{\"href\":\"/\",\"children\":\"MainJayLai Blog\"}]]}]]}]}]]}]}]]}]}]]}],null],null],\"couldBeIntercepted\":false,\"initialHead\":[false,\"$L15\"],\"globalErrorComponent\":\"$16\",\"missingSlots\":\"$W17\"}]]\n"])</script><script>self.__next_f.push([1,"18:I[4347,[\"231\",\"static/chunks/231-34a6a67d2da26855.js\",\"827\",\"static/chunks/827-69594f61c16b8a9c.js\",\"797\",\"static/chunks/app/blog/%5B...slug%5D/page-bd056182432da53b.js\"],\"default\"]\n19:I[408,[\"231\",\"static/chunks/231-34a6a67d2da26855.js\",\"827\",\"static/chunks/827-69594f61c16b8a9c.js\",\"797\",\"static/chunks/app/blog/%5B...slug%5D/page-bd056182432da53b.js\"],\"default\"]\n1a:I[9629,[\"231\",\"static/chunks/231-34a6a67d2da26855.js\",\"827\",\"static/chunks/827-69594f61c16b8a9c.js\",\"797\",\"static/chunks/app/blog/%5B...slug%5D/page-bd056182432da53b.js\"],\"default\"]\n"])</script><script>self.__next_f.push([1,"7:[[\"$\",\"script\",null,{\"type\":\"application/ld+json\",\"dangerouslySetInnerHTML\":{\"__html\":\"{\\\"@context\\\":\\\"https://schema.org\\\",\\\"@type\\\":\\\"BlogPosting\\\",\\\"headline\\\":\\\"深入理解Go SQL内部机制\\\",\\\"datePublished\\\":\\\"2024-11-13T00:00:00.000Z\\\",\\\"dateModified\\\":\\\"2024-11-13T00:00:00.000Z\\\",\\\"description\\\":\\\"这是一篇关于Go SQL内部机制的深度解析文章。文章详细探讨了预处理语句的工作原理、连接池的生命周期管理，以及实际生产环境中常见的问题和解决方案。同时提供了具体的客户端和服务器端配置建议，对于构建高性能Go数据库应用具有重要的参考价值。\\\",\\\"image\\\":\\\"https://pngimg.com/uploads/github/github_PNG80.png\\\",\\\"url\\\":\\\"https://blog.mainjay.cloudns.ch/blog/go/go-sql\\\",\\\"author\\\":[{\\\"@type\\\":\\\"Person\\\",\\\"name\\\":\\\"mainJayLai\\\"}]}\"}}],[\"$\",\"section\",null,{\"className\":\"mx-auto max-w-3xl px-4 sm:px-6 xl:max-w-5xl xl:px-0\",\"children\":[[\"$\",\"$L18\",null,{}],[\"$\",\"article\",null,{\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"header\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"space-y-1 border-b border-gray-200 pb-10 text-center dark:border-gray-700\",\"children\":[[\"$\",\"div\",null,{\"className\":\"beautiful-chinese-title\",\"children\":[\"$\",\"h1\",null,{\"className\":\"text-3xl font-extrabold leading-9 tracking-tight text-gray-900 dark:text-gray-100 sm:text-4xl sm:leading-10 md:text-5xl md:leading-14\",\"children\":\"深入理解Go SQL内部机制\"}]}],[\"$\",\"dl\",null,{\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"dt\",null,{\"className\":\"sr-only\",\"children\":\"Published on\"}],[\"$\",\"dd\",null,{\"className\":\"text-base font-medium leading-6 text-gray-500 dark:text-gray-400\",\"children\":[\"$\",\"time\",null,{\"dateTime\":\"2024-11-13T00:00:00.000Z\",\"children\":\"November 13, 2024\"}]}]]}]}]]}]}],[\"$\",\"div\",null,{\"className\":\"grid-rows-[auto_1fr] divide-y divide-gray-200 pb-8 dark:divide-gray-700 xl:divide-y-0\",\"children\":[[\"$\",\"div\",null,{\"className\":\"divide-y divide-gray-200 dark:divide-gray-700 xl:col-span-3 xl:row-span-2 xl:pb-0\",\"children\":[\"$\",\"div\",null,{\"className\":\"beautiful-chinese-content prose max-w-none pb-8 pt-10 dark:prose-invert\",\"children\":[[\"$\",\"h2\",null,{\"className\":\"content-header\",\"id\":\"引言\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#引言\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"引言\"]}],[\"$\",\"p\",null,{\"children\":\"在本文中，我们将探索Go的SQL和MySQL驱动程序的内部工作原理，揭示优化数据库交互和最小化错误的关键见解。这些见解来自对Go SQL标准库和Go MySQL驱动程序源代码的深入研究。\"}],[\"$\",\"p\",null,{\"children\":\"主要关键点：\"}],[\"$\",\"ul\",null,{\"children\":[[\"$\",\"li\",null,{\"children\":\"预处理语句：高效且安全的SQL执行\"}],[\"$\",\"li\",null,{\"children\":\"连接生命周期：资源使用和连接池维护\"}],[\"$\",\"li\",null,{\"children\":\"实际问题：解决微服务架构中的常见挑战\"}]]}],[\"$\",\"p\",null,{\"children\":[\"在下文中，我们通过内联方式阐释Go概念。小写术语表示包名，大写术语表示类型名。括号表示方法，没有括号则表示类型。例如，\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"sql.Stmt\"}],\"指的是sql包中的Stmt类型，而\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"Stmt.QueryContext()\"}],\"表示Stmt类型上的QueryContext方法。\"]}],[\"$\",\"h3\",null,{\"className\":\"content-header\",\"id\":\"为什么这很重要\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#为什么这很重要\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"为什么这很重要\"]}],[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"深入理解SQL和MySQL驱动程序在Go中的工作方式对构建高性能应用至关重要\"}],\"。通过深入研究预处理语句和连接生命周期等概念，我们可以优化数据库交互并有效处理故障。这些知识使开发人员能够编写更好的代码，并最大限度地减少数据库问题导致的错误。\"]}],[\"$\",\"h2\",null,{\"className\":\"content-header\",\"id\":\"预处理语句\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#预处理语句\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"预处理语句\"]}],[\"$\",\"p\",null,{\"children\":\"预处理语句是由DBMS解析和保存的SQL，通常包含占位符但没有实际参数值。之后，该语句可以使用一组参数值执行。\"}],[\"$\",\"p\",null,{\"children\":\"预处理语句的优势是：\"}],[\"$\",\"ul\",null,{\"children\":[[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"效率\"}],\"：可以重复使用而无需重新编译\"]}],[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"安全性\"}],\"：减少或消除SQL注入攻击\"]}]]}],[\"$\",\"p\",null,{\"children\":\"虽然出于安全目的使用预处理语句确实是个好理由，但说实话，它们使用的主要动机是效率，正如我将在本文其余部分进一步解释的那样。\"}],[\"$\",\"h3\",null,{\"className\":\"content-header\",\"id\":\"预处理语句生命周期\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#预处理语句生命周期\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"预处理语句生命周期\"]}],[\"$\",\"p\",null,{\"children\":\"当我们想要在预处理语句上执行查询时，需要执行以下步骤：\"}],[\"$\",\"ol\",null,{\"children\":[[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"语句准备\"}],\"：\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"DB.Prepare()\"}],\"方法准备SQL语句并返回一个\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"sql.Stmt\"}],\"对象\"]}],[\"$\",\"li\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"查询执行\"}],\"：当使用\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"Stmt.Query()\"}],\"执行查询时，驱动程序从连接池中检索连接，将SQL语句发送到数据库服务器，并等待结果\"]}]]}],[\"$\",\"h3\",null,{\"className\":\"content-header\",\"id\":\"语句准备\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#语句准备\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"语句准备\"]}],[\"$\",\"p\",null,{\"children\":[\"要准备语句，客户端从连接池中获取连接并将查询发送到DBMS，DBMS解析查询并将语句ID返回给客户端，然后客户端构建\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"sql.Stmt\"}],\"对象。\"]}],[\"$\",\"h3\",null,{\"className\":\"content-header\",\"id\":\"查询执行\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#查询执行\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"查询执行\"]}],[\"$\",\"p\",null,{\"children\":[\"要使用\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"Stmt.QueryContext()\"}],\"执行查询，客户端从池中检索连接。预处理语句的范围仅限于创建它的连接。因此，\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"sql.Stmt\"}],\"必须验证连接是否已准备好。如果没有，它会自动准备连接，发送参数，并返回\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"sql.Rows\"}],\"。随后，我们使用\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"Rows.Scan()\"}],\"检索行数据。调用\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"Rows.Close()\"}],\"时释放连接。\"]}],[\"$\",\"p\",null,{\"children\":\"我们在这里获得效率，因为每次需要运行查询时都不需要发送整个查询字符串，DBMS也不需要解析查询。如果QPS（每秒查询数）很高，先准备它，然后执行它是有意义的。\"}],[\"$\",\"p\",null,{\"children\":\"到目前为止，我已经概述了使用连接的两个阶段：获取和释放它们。\"}],[\"$\",\"p\",null,{\"children\":\"让我们先讨论释放连接，然后再讨论如何获取连接。\"}],[\"$\",\"h3\",null,{\"className\":\"content-header\",\"id\":\"释放连接\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#释放连接\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"释放连接\"]}],[\"$\",\"p\",null,{\"children\":\"一旦查询执行完成并处理结果集，连接就返回到连接池中，允许其他查询重用它。\"}],[\"$\",\"p\",null,{\"children\":\"释放SQL连接的关键规则：\"}],[\"$\",\"div\",null,{\"className\":\"flex flex-col items-center justify-center text-center\",\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"$Lf\",null,{\"src\":\"/static/images/go/go-sql/picture1.webp\",\"alt\":\"Maple\",\"width\":\"828\",\"height\":\"417\"}],\" 在Go中释放SQL连接：检查最大打开和空闲连接，并处理挂起的请求。\"]}]}],[\"$\",\"$L19\",null,{\"className\":\"language-go\",\"children\":[\"$\",\"code\",null,{\"className\":\"code-highlight language-go\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 设置最大打开连接数\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"db\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"SetMaxOpenConns\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"100\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 设置最大空闲连接数\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"db\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"SetMaxIdleConns\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"100\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}]]}]}],[\"$\",\"ul\",null,{\"children\":[[\"$\",\"li\",null,{\"children\":[\"如果当前打开的连接数超过了\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"DB.SetMaxOpenConns(int)\"}],\"允许的最大值，空闲连接会立即关闭而不返回到空闲列表\"]}],[\"$\",\"li\",null,{\"children\":[\"如果有挂起的连接请求，空闲连接会转发给该请求；否则，如果挂起的连接数低于\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"DB.SetMaxIdleConns(int)\"}],\"设置的最大空闲连接数，连接会被追加到空闲连接列表中以供后续使用\"]}],[\"$\",\"li\",null,{\"children\":[\"否则，连接将立即关闭，\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"DBStats.MaxIdleClosed\"}],\"指标增加。\"]}]]}],[\"$\",\"p\",null,{\"children\":[\"Go不会无限期保留空闲连接；它会定期清理它们。连接清理作业会关闭空闲时间超过最大空闲时间的连接，以及生命周期超过最大生命周期的连接。这个过程确保空闲连接得到及时清理。两个指标\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"DBStats.MaxIdleTimeClosed\"}],\"和\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"DBStats.MaxLifetimeClosed\"}],\"表示这种行为。\"]}],[\"$\",\"p\",null,{\"children\":\"在内部，三个测量指标代表这些连接：\"}],[\"$\",\"ul\",null,{\"children\":[[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"DBStats.Idle\"}],\"：显示可用的空闲连接数\"]}],[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"DBStats.InUse\"}],\"：表示当前运行查询的连接数\"]}],[\"$\",\"li\",null,{\"children\":[[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"DBStats.OpenConnections\"}],\"：这两个指标的总和\"]}]]}],[\"$\",\"h3\",null,{\"className\":\"content-header\",\"id\":\"获取连接\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#获取连接\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"获取连接\"]}],[\"$\",\"p\",null,{\"children\":\"现在，让我们深入研究管理数据库连接的过程。\"}],[\"$\",\"div\",null,{\"className\":\"flex flex-col items-center justify-center text-center\",\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"$Lf\",null,{\"src\":\"/static/images/go/go-sql/picture2.webp\",\"alt\":\"Maple\",\"width\":\"1386\",\"height\":\"882\"}],\" 在Go中获取/抓取SQL连接：重用现有连接、打开新连接和管理连接到期\"]}]}],[\"$\",\"h4\",null,{\"className\":\"content-header\",\"id\":\"连接重用尝试\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#连接重用尝试\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"连接重用尝试\"]}],[\"$\",\"p\",null,{\"children\":[\"当使用Go时，它会尝试重用空闲列表中的连接。它检查每个连接的生命周期。如果连接的生命周期超过由\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"DB.SetConnMaxLifetime(time.Duration)\"}],\"设置的最大值，它会关闭连接并返回\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"driver.ErrBadConn\"}],\"。在两次重试后，如果错误仍然存在，它会尝试打开新连接。在返回连接之前，它会使用其DB驱动程序（例如MySQL驱动程序）重置连接，以验证连接的活跃性。\"]}],[\"$\",\"h4\",null,{\"className\":\"content-header\",\"id\":\"处理连接稀缺\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#处理连接稀缺\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"处理连接稀缺\"]}],[\"$\",\"p\",null,{\"children\":\"如果我们用完了空闲连接或被明确指示不使用连接，我们有两个选择：\"}],[\"$\",\"ol\",null,{\"children\":[[\"$\",\"li\",null,{\"children\":\"建立新连接\"}],[\"$\",\"li\",null,{\"children\":\"请求连接并等待直到连接池中有可用连接\"}]]}],[\"$\",\"p\",null,{\"children\":[\"在这种情况下，它会重置连接。在等待连接可用时，两个额外的指标会增加：\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"DBStats.WaitCount\"}],\"和\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"DBStats.WaitDuration\"}],\"。\"]}],[\"$\",\"h2\",null,{\"className\":\"content-header\",\"id\":\"实际问题\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#实际问题\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"实际问题\"]}],[\"$\",\"p\",null,{\"children\":\"我们有一些使用Go编程语言开发的微服务。这些微服务使用MariaDB服务集群进行数据持久化。我们使用ProxySQL来为这些服务提供高可用性。\"}],[\"$\",\"div\",null,{\"className\":\"flex flex-col items-center justify-center text-center\",\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"$Lf\",null,{\"src\":\"/static/images/go/go-sql/picture3.webp\",\"alt\":\"Maple\",\"width\":\"828\",\"height\":\"800\"}],\" ProxySQL和MariaDB集群的服务架构\"]}]}],[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"如果我们无法从DBMS获取数据，我们会向客户端响应内部错误\"}],\"。故障可能出现在以下链接之一：\"]}],[\"$\",\"ul\",null,{\"children\":[[\"$\",\"li\",null,{\"children\":\"应用服务器和ProxySQL集群之间\"}],[\"$\",\"li\",null,{\"children\":\"ProxySQL服务和MariaDB服务之间\"}]]}],[\"$\",\"p\",null,{\"children\":\"如果这些链接中的任何一个失败，都可能导致运行查询时出错，从而增加内部错误率。\"}],[\"$\",\"h3\",null,{\"className\":\"content-header\",\"id\":\"waitcount增加问题\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#waitcount增加问题\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"WaitCount增加问题\"]}],[\"$\",\"p\",null,{\"children\":\"一个奇怪的现象是，根据我们的指标，打开的连接数只有最大限制的一半。\"}],[\"$\",\"div\",null,{\"className\":\"flex flex-col items-center justify-center text-center\",\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"$Lf\",null,{\"src\":\"/static/images/go/go-sql/picture4.webp\",\"alt\":\"Maple\",\"width\":\"828\",\"height\":\"237\"}],\" 打开的连接数稳定在15左右\"]}]}],[\"$\",\"p\",null,{\"children\":\"因此，等待计数不应该增加，但它确实增加了。如果等待持续时间不保持稳定，它可能会影响响应时间。\"}],[\"$\",\"div\",null,{\"className\":\"flex flex-col items-center justify-center text-center\",\"children\":[\"$\",\"div\",null,{\"children\":[[\"$\",\"$Lf\",null,{\"src\":\"/static/images/go/go-sql/picture5.webp\",\"alt\":\"Maple\",\"width\":\"828\",\"height\":\"237\"}],\" waitCount 在增加\"]}]}],[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"突然增加的请求会导致连接使用增加，由于采样间隔（每10-15秒），这种情况往往不会立即显现\"}],\"。例如，虽然一个图表显示稳定的打开连接，但另一个可能显示等待计数激增，表明请求增加。仅60个额外的同时请求就会导致空闲连接饱和，造成队列。仅依赖单一指标可能导致误解；考虑多个指标对准确性至关重要。\"]}],[\"$\",\"p\",null,{\"children\":[\"要解决此问题，请考虑增加最大打开连接数（\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"DB.SetMaxOpenConns(int)\"}],\"）。如果由于应用程序实例总数超过总允许的最大连接数而无法提高此限制，你可能需要在增加最大打开连接数之前减少应用程序实例的数量。\"]}],[\"$\",\"h3\",null,{\"className\":\"content-header\",\"id\":\"内部错误增加\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#内部错误增加\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"内部错误增加\"]}],[\"$\",\"p\",null,{\"children\":\"我的探索发现，虽然Go的SQL标准库尝试重置连接以进行可用性检查，但它并不能完全修复无效连接错误。例如意外EOF等错误会影响响应时间，增加内部错误，并使用户不满意。调查显示，这个问题是由DBMS相关服务器参数（如ProxySQL或MariaDB）调整不当造成的。\"}],[\"$\",\"$L19\",null,{\"className\":\"language-js\",\"children\":[\"$\",\"code\",null,{\"className\":\"code-highlight language-js\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token class-name known-class-name\",\"children\":\"Error\"}],\" #\",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"01\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" invalid connection\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"[\"}],\"mysql\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"]\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"2024\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"/\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"03\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"/\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"29\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"16\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"49\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"43\"}],\" packets\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token property-access\",\"children\":\"go\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"37\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" unexpected \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"EOF\"}],\"\\n\"]}]]}]}],[\"$\",\"p\",null,{\"children\":[\"MySQL在\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"wait_timeout\"}],\"后终止空闲连接，但ProxySQL没有收到通知，导致错误假设连接状态。\"]}],[\"$\",\"p\",null,{\"children\":[\"要解决这个问题，需要将\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"mysql-ping_interval_server_msec\"}],\"减少到与\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"wait_timeout\"}],\"相匹配或更低。这会提示ProxySQL检查空闲连接并避免将请求重定向到已终止的连接。\"]}],[\"$\",\"p\",null,{\"children\":\"使用这些设置还将完全解决ProxySQL的以下警告。\"}],[\"$\",\"$L19\",null,{\"className\":\"language-js\",\"children\":[\"$\",\"code\",null,{\"className\":\"code-highlight language-js\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"mariadb3 \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"|\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"2024\"}],\"–\",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"03\"}],\"–\",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"28\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"21\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"07\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"34\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"591\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"[\"}],[\"$\",\"span\",null,{\"className\":\"token maybe-class-name\",\"children\":\"Warning\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"]\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token maybe-class-name\",\"children\":\"Aborted\"}],\" connection \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"591\"}],\" to db\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'mydb'\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token literal-property property\",\"children\":\"user\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'app'\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token literal-property property\",\"children\":\"host\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'172.25.0.5'\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token maybe-class-name\",\"children\":\"Got\"}],\" timeout reading communication packets\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token maybe-class-name\",\"children\":\"Then\"}],\" it gets the following error when the app tries to open \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"new\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token class-name\",\"children\":\"connection\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"proxysql \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"|\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"2024\"}],\"–\",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"03\"}],\"–\",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"28\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"21\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"08\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"56\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token maybe-class-name\",\"children\":\"MySQL_Session\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token property-access\",\"children\":\"cpp\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"1694\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"handler_again___status_PINGING_SERVER\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"[\"}],[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"ERROR\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"]\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token maybe-class-name\",\"children\":\"Detected\"}],\" a broken connection \",[\"$\",\"span\",null,{\"className\":\"token keyword control-flow\",\"children\":\"while\"}],\" during ping \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"on\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"1\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\"mariadb2\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"3306\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"604\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"FD\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token maybe-class-name\",\"children\":\"Conn\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"80\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token literal-property property\",\"children\":\"MyDS\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"80\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" user app \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" last_used 0ms ago \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"2006\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\",\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token maybe-class-name\",\"children\":\"MySQL\"}],\" server has gone away\\n\"]}]]}]}],[\"$\",\"p\",null,{\"children\":\"ProxySQL不会关闭连接，从而导致记录上述错误。\"}],[\"$\",\"blockquote\",null,{\"children\":[\"$\",\"p\",null,{\"children\":[\"默认情况下，连接不会根据其年龄而关闭。当达到\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"mysql-connection_max_age_ms\"}],\"时，连接会简单地断开，而不会向服务器发送\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"COM_QUIT\"}],\"命令，因此这可能会导致mysql服务器日志中显示\",[\"$\",\"strong\",null,{\"children\":\"中止连接\"}],\"警告（这种行为是故意的）。\"]}]}],[\"$\",\"h3\",null,{\"className\":\"content-header\",\"id\":\"最大连接数\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#最大连接数\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"最大连接数\"]}],[\"$\",\"p\",null,{\"children\":[\"考虑这种情况：如果ProxySQL中的\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"max_connections\"}],\"值设置为99，而我们在应用程序中将最大打开连接配置为100，测试显示99.5%的正常运行时间，有0.5%的响应导致内部错误。\"]}],[\"$\",\"p\",null,{\"children\":\"ProxySQL会记录以下警告：\"}],[\"$\",\"$L19\",null,{\"className\":\"language-js\",\"children\":[\"$\",\"code\",null,{\"className\":\"code-highlight language-js\",\"children\":[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"proxysql  \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"|\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"2024\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"-\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"03\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"-\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"30\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"19\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"38\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"05\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token maybe-class-name\",\"children\":\"MySQL_Session\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token property-access\",\"children\":\"cpp\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"5504\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"handler___status_CONNECTING_CLIENT___STATE_SERVER_HANDSHAKE\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"[\"}],[\"$\",\"span\",null,{\"className\":\"token constant\",\"children\":\"WARNING\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"]\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token maybe-class-name\",\"children\":\"User\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'app'\"}],\" has exceeded the \",[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'max_user_connections'\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"resource\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],\"current value\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\":\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"99\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}]}]}],[\"$\",\"p\",null,{\"children\":\"这种情况强调了准确调整参数的重要性。\"}],[\"$\",\"h2\",null,{\"className\":\"content-header\",\"id\":\"建议\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#建议\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"建议\"]}],[\"$\",\"h3\",null,{\"className\":\"content-header\",\"id\":\"客户端建议\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#客户端建议\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"客户端建议\"]}],[\"$\",\"p\",null,{\"children\":\"Go-SQL-Driver的自述文件中提到了一些很好的建议：\"}],[\"$\",\"blockquote\",null,{\"children\":[[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"db.SetConnMaxLifetime()\"}],\" 是必需的，用于确保驱动程序在连接被 MySQL 服务器、操作系统或其他中间件关闭之前安全地关闭连接。由于一些中间件会在 5 分钟后关闭空闲连接，我们建议将超时时间设置为小于 5 分钟。这个设置也有助于负载均衡和更改系统变量。\"]}],[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"db.SetMaxOpenConns()\"}],\" 强烈建议设置，用于限制应用程序使用的连接数量。没有推荐的具体限制数字，因为这取决于应用程序和 MySQL 服务器的具体情况。\"]}],[\"$\",\"p\",null,{\"children\":[[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"db.SetMaxIdleConns()\"}],\" 建议设置为与 \",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"db.SetMaxOpenConns()\"}],\" 相同的值。当它小于 \",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"SetMaxOpenConns()\"}],\" 时，连接的开启和关闭频率可能会比您预期的要高得多。空闲连接可以通过 \",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"db.SetConnMaxLifetime()\"}],\" 来关闭。如果您想更快地关闭空闲连接，从 Go 1.15 版本开始，您可以使用 \",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"db.SetConnMaxIdleTime()\"}],\"。\"]}]]}],[\"$\",\"p\",null,{\"children\":[\"$\",\"strong\",null,{\"children\":\"配置建议：\"}]}],[\"$\",\"$L19\",null,{\"className\":\"language-go\",\"children\":[\"$\",\"code\",null,{\"className\":\"code-highlight language-go\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 设置连接最大生存期（小于wait_time设置）\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"db\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"SetConnMaxLifetime\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"...\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 设置与ConnMaxLifetime相同\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"db\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"SetConnMaxIdleTime\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"...\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 最大连接数限制除以pod数量\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"db\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"SetMaxOpenConns\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"...\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"// 与MaxOpenConns相同\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"db\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"SetMaxIdleConns\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"...\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}]]}]}],[\"$\",\"p\",null,{\"children\":[\"通过执行指定的查询，您将发现\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"max_connections\"}],\"设置：\"]}],[\"$\",\"$L19\",null,{\"children\":[\"$\",\"code\",null,{\"className\":\"code-highlight language-mysql\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"ProxySQL Admin\u003e select hostgroup_id, hostname, max_connections from mysql_servers;\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"+--------------+----------+-----------------+\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"| hostgroup_id | hostname | max_connections |\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"+--------------+----------+-----------------+\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"| 0            | mariadb1 | 20              |\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"| 1            | mariadb2 | 300             |\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"| 1            | mariadb3 | 300             |\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"+--------------+----------+-----------------+\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"ProxySQL Admin\u003e select username, max_connections from mysql_users;\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"+----------+-----------------+\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"| username | max_connections |\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"+----------+-----------------+\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"| root     | 25              |\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"| app      | 300             |\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"+----------+-----------------+\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"ProxySQL Admin\u003e select * from global_variables where variable_name in ('mysql-wait_timeout') order by variable_name;\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"+--------------------+----------------+\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"| variable_name      | variable_value |\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"+--------------------+----------------+\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"| mysql-wait_timeout | 60000          |\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"+--------------------+----------------+\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"mysql\u003e show variables where Variable_name in ('max_connections','wait_timeout');\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"+-----------------+-------+\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"| Variable_name   | Value |\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"+-----------------+-------+\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"| max_connections | 300   |\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"| wait_timeout    | 600   |\\n\"}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":\"+-----------------+-------+\\n\"}]]}]}],[\"$\",\"p\",null,{\"children\":\"根据这些值，我们应该将连接的最大生存期设置为最多60秒。如果我们运行一个应用程序的3个实例，则最大打开连接数应设置为100。\"}],[\"$\",\"$L19\",null,{\"className\":\"language-go\",\"children\":[\"$\",\"code\",null,{\"className\":\"code-highlight language-go\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"db\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"SetConnMaxLifetime\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"60\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"*\"}],\" time\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"Second\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"db\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"SetConnMaxIdleTime\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"60\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"*\"}],\" time\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],\"Second\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"db\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"SetMaxOpenConns\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"100\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"db\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\".\"}],[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"SetMaxIdleConns\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"100\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\"\\n\"]}]]}]}],[\"$\",\"h3\",null,{\"className\":\"content-header\",\"id\":\"服务器端建议\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#服务器端建议\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"服务器端建议\"]}],[\"$\",\"p\",null,{\"children\":[\"根据\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"wait_timeout\"}],\"调整\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"mysql-ping_interval_server_msec\"}],\"。它应该小于或等于\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"wait_timeout\"}],\"，而不是更大。对已经被MySQL服务器终止的连接进行ping是没有意义的。\"]}],[\"$\",\"p\",null,{\"children\":[\"$\",\"strong\",null,{\"children\":\"示例配置查询：\"}]}],[\"$\",\"$L19\",null,{\"className\":\"language-sql\",\"children\":[\"$\",\"code\",null,{\"className\":\"code-highlight language-sql\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"-- 查询服务器配置\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"ProxySQL Admin\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"\u003e\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"select\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"*\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"from\"}],\" global_variables \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"where\"}],\" variable_name \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"in\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\"(\"}],[\"$\",\"span\",null,{\"className\":\"token string\",\"children\":\"'mysql-ping_interval_server_msec'\"}],[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\")\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"order\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token keyword\",\"children\":\"by\"}],\" variable_name\",[\"$\",\"span\",null,{\"className\":\"token punctuation\",\"children\":\";\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"+\"}],[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"---------------------------------+----------------+\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"|\"}],\" variable_name                   \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"|\"}],\" variable_value \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"|\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"+\"}],[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"---------------------------------+----------------+\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"|\"}],\" mysql\",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"-\"}],\"ping_interval_server_msec \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"|\"}],\" \",[\"$\",\"span\",null,{\"className\":\"token number\",\"children\":\"120000\"}],\"         \",[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"|\"}],\"\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token operator\",\"children\":\"+\"}],[\"$\",\"span\",null,{\"className\":\"token comment\",\"children\":\"---------------------------------+----------------+\"}],\"\\n\"]}]]}]}],[\"$\",\"p\",null,{\"children\":\"返回的结果表明配置设置不正确。适当的值应该小于60000毫秒（60秒）。值得一提的是，ProxySQL的默认值是10000毫秒（10秒）。\"}],[\"$\",\"h2\",null,{\"className\":\"content-header\",\"id\":\"动手实践\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#动手实践\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"动手实践\"]}],[\"$\",\"p\",null,{\"children\":\"要开始，克隆源代码仓库。确保系统上安装了Go、K6和Docker。\"}],[\"$\",\"$L19\",null,{\"className\":\"language-bash\",\"children\":[\"$\",\"code\",null,{\"className\":\"code-highlight language-bash\",\"children\":[[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"git\"}],\" clone git@github.com:empire/db-prepared-stmt.git\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token class-name builtin\",\"children\":\"cd\"}],\" galera\\n\"]}],[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[[\"$\",\"span\",null,{\"className\":\"token function\",\"children\":\"docker\"}],\" compose up --remove-orphans\\n\"]}]]}]}],[\"$\",\"p\",null,{\"children\":\"集群启动后，执行以下命令运行服务：\"}],[\"$\",\"$L19\",null,{\"className\":\"language-bash\",\"children\":[\"$\",\"code\",null,{\"className\":\"code-highlight language-bash\",\"children\":[\"$\",\"span\",null,{\"className\":\"code-line\",\"children\":[\"go run \",[\"$\",\"span\",null,{\"className\":\"token class-name builtin\",\"children\":\".\"}],\"\\n\"]}]}]}],[\"$\",\"p\",null,{\"children\":[\"要模拟样本负载，你可以使用k6命令或运行\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"run_watched.sh\"}],\"脚本。为了方便监控MySQL资源和进程列表，我创建了一个名为\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"monitor.sh\"}],\"的脚本。你可以使用命令\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"watch -n 1 ./monitor.sh\"}],\"执行它。\"]}],[\"$\",\"p\",null,{\"children\":[\"如果需要自定义配置，打开\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"galera/docker-compose.yml\"}],\"和\",[\"$\",\"code\",null,{\"className\":\"custom-code\",\"children\":\"galera/proxysql/proxysql.cnf\"}],\"文件。对变量进行必要的更改，然后重启Docker Compose命令。\"]}],[\"$\",\"h2\",null,{\"className\":\"content-header\",\"id\":\"结论\",\"children\":[[\"$\",\"a\",null,{\"href\":\"#结论\",\"aria-hidden\":\"true\",\"tabIndex\":\"-1\",\"children\":[\"$\",\"span\",null,{\"className\":\"content-header-link\",\"children\":[\"$\",\"svg\",null,{\"className\":\"h-5 linkicon w-5\",\"fill\":\"currentColor\",\"viewBox\":\"0 0 20 20\",\"xmlns\":\"http://www.w3.org/2000/svg\",\"children\":[[\"$\",\"path\",null,{\"d\":\"M12.232 4.232a2.5 2.5 0 0 1 3.536 3.536l-1.225 1.224a.75.75 0 0 0 1.061 1.06l1.224-1.224a4 4 0 0 0-5.656-5.656l-3 3a4 4 0 0 0 .225 5.865.75.75 0 0 0 .977-1.138 2.5 2.5 0 0 1-.142-3.667l3-3Z\"}],[\"$\",\"path\",null,{\"d\":\"M11.603 7.963a.75.75 0 0 0-.977 1.138 2.5 2.5 0 0 1 .142 3.667l-3 3a2.5 2.5 0 0 1-3.536-3.536l1.225-1.224a.75.75 0 0 0-1.061-1.06l-1.224 1.224a4 4 0 1 0 5.656 5.656l3-3a4 4 0 0 0-.225-5.865Z\"}]]}]}]}],\"结论\"]}],[\"$\",\"p\",null,{\"children\":[[\"$\",\"strong\",null,{\"children\":\"理解Go的SQL和MySQL驱动程序的内部工作原理使开发人员能够优化数据库交互并有效解决潜在故障\"}],\"。通过利用预处理语句、管理连接生命周期和应用最佳实践，开发人员可以提高应用程序性能并最小化内部错误。\"]}],[\"$\",\"p\",null,{\"children\":\"我的探索揭示了有效资源管理和故障排除技术的关键见解，特别是在分布式系统中。通过实施推荐的配置并及时了解数据库技术，开发人员可以确保应用程序的平稳运行并提供卓越的用户体验。\"}]]}]}],[\"$\",\"div\",null,{\"className\":\"pb-6 pt-6 text-center text-gray-700 dark:text-gray-300\",\"id\":\"comment\",\"children\":[\"$\",\"$L1a\",null,{\"slug\":\"go/go-sql\"}]}],[\"$\",\"footer\",null,{\"children\":[\"$\",\"div\",null,{\"className\":\"flex flex-col text-sm font-medium sm:flex-row sm:justify-between sm:text-base\",\"children\":[[\"$\",\"div\",null,{\"className\":\"pt-4 xl:pt-8\",\"children\":[\"$\",\"$Le\",null,{\"href\":\"/blog/go/fuzzing-test\",\"className\":\"text-primary-500 hover:text-primary-600 dark:hover:text-primary-400\",\"aria-label\":\"Previous post: Go语言 HTTP 服务模糊测试教程\",\"children\":[\"← \",\"Go语言 HTTP 服务模糊测试教程\"]}]}],[\"$\",\"div\",null,{\"className\":\"pt-4 xl:pt-8\",\"children\":[\"$\",\"$Le\",null,{\"href\":\"/blog/frontend/javascript-function\",\"className\":\"text-primary-500 hover:text-primary-600 dark:hover:text-primary-400\",\"aria-label\":\"Next post: 深入探讨 JavaScript 中的函数式编程\",\"children\":[\"深入探讨 JavaScript 中的函数式编程\",\" →\"]}]}]]}]}]]}]]}]}]]}]]\n"])</script><script>self.__next_f.push([1,"15:[[\"$\",\"meta\",\"0\",{\"name\":\"viewport\",\"content\":\"width=device-width, initial-scale=1\"}],[\"$\",\"meta\",\"1\",{\"charSet\":\"utf-8\"}],[\"$\",\"title\",\"2\",{\"children\":\"深入理解Go SQL内部机制\"}],[\"$\",\"meta\",\"3\",{\"name\":\"description\",\"content\":\"这是一篇关于Go SQL内部机制的深度解析文章。文章详细探讨了预处理语句的工作原理、连接池的生命周期管理，以及实际生产环境中常见的问题和解决方案。同时提供了具体的客户端和服务器端配置建议，对于构建高性能Go数据库应用具有重要的参考价值。\"}],[\"$\",\"meta\",\"4\",{\"name\":\"robots\",\"content\":\"index, follow\"}],[\"$\",\"meta\",\"5\",{\"name\":\"googlebot\",\"content\":\"index, follow, max-video-preview:-1, max-image-preview:large, max-snippet:-1\"}],[\"$\",\"link\",\"6\",{\"rel\":\"canonical\",\"href\":\"https://blog.mainjay.cloudns.ch/blog/go/go-sql\"}],[\"$\",\"link\",\"7\",{\"rel\":\"alternate\",\"type\":\"application/rss+xml\",\"href\":\"https://blog.mainjay.cloudns.ch/feed.xml\"}],[\"$\",\"meta\",\"8\",{\"property\":\"og:title\",\"content\":\"深入理解Go SQL内部机制\"}],[\"$\",\"meta\",\"9\",{\"property\":\"og:description\",\"content\":\"这是一篇关于Go SQL内部机制的深度解析文章。文章详细探讨了预处理语句的工作原理、连接池的生命周期管理，以及实际生产环境中常见的问题和解决方案。同时提供了具体的客户端和服务器端配置建议，对于构建高性能Go数据库应用具有重要的参考价值。\"}],[\"$\",\"meta\",\"10\",{\"property\":\"og:url\",\"content\":\"https://blog.mainjay.cloudns.ch/blog/go/go-sql\"}],[\"$\",\"meta\",\"11\",{\"property\":\"og:site_name\",\"content\":\"MainJayLai Blog\"}],[\"$\",\"meta\",\"12\",{\"property\":\"og:locale\",\"content\":\"en_US\"}],[\"$\",\"meta\",\"13\",{\"property\":\"og:image\",\"content\":\"https://pngimg.com/uploads/github/github_PNG80.png\"}],[\"$\",\"meta\",\"14\",{\"property\":\"og:type\",\"content\":\"article\"}],[\"$\",\"meta\",\"15\",{\"property\":\"article:published_time\",\"content\":\"2024-11-13T00:00:00.000Z\"}],[\"$\",\"meta\",\"16\",{\"property\":\"article:modified_time\",\"content\":\"2024-11-13T00:00:00.000Z\"}],[\"$\",\"meta\",\"17\",{\"property\":\"article:author\",\"content\":\"mainJayLai\"}],[\"$\",\"meta\",\"18\",{\"name\":\"twitter:card\",\"content\":\"summary_large_image\"}],[\"$\",\"meta\",\"19\",{\"name\":\"twitter:title\",\"content\":\"深入理解Go SQL内部机制\"}],[\"$\",\"meta\",\"20\",{\"name\":\"twitter:description\",\"content\":\"这是一篇关于Go SQL内部机制的深度解析文章。文章详细探讨了预处理语句的工作原理、连接池的生命周期管理，以及实际生产环境中常见的问题和解决方案。同时提供了具体的客户端和服务器端配置建议，对于构建高性能Go数据库应用具有重要的参考价值。\"}],[\"$\",\"meta\",\"21\",{\"name\":\"twitter:image\",\"content\":\"https://pngimg.com/uploads/github/github_PNG80.png\"}],[\"$\",\"meta\",\"22\",{\"name\":\"next-size-adjust\"}]]\n"])</script><script>self.__next_f.push([1,"6:null\n"])</script></body></html>